name: Generated artifacts
on:
  workflow_dispatch:
  push:
    branches:
      - master
    tags:
      - "*"
  pull_request:
    paths:
      - "generator/**"
      - "spec/**"
      - "c/test/**"
      - "rust/sbp/tests/**"
jobs:
  generation:
    name: Generated artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Run generator
        run: |
          pip3 install tox
          rm c/test/auto_check_*.c c/test/cpp/auto_check_*.cc rust/sbp/tests/auto_check_*.rs
          make gen-c gen-rust

      - name: Check
        run: |
          git add c/test/ rust/sbp/tests/
          git diff --cached --name-only --exit-code
          git diff --name-only --exit-code
